---
title: "Optimum Pass/Run Ratio in NFL"
author: "CMSAC Reproducible Research Competition"
date: "October 2020"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Abstract

NFL passing plays have higher expected points added (EPA) than running plays in almost every game situation.  A recent article by Lau Sze Yui^[Yui, L.S.(2020, March 23). *Finding the optimal pass/run ratio.* Football Outsiders. http://www.footballoutsiders.com/stat-analysis/2020/finding-optimal-passrun-ratio.] concludes, however, that passing on every play is not viable.  Nevertheless, Yui's article suggests that the correct passing equilibrium is far from current run/pass ratios.

The relationship between EPA and Win Probability (WP) is the starting point for determining the optimal pass-run percentage.  At low WPs, run plays have their highest EPAs and even have higher EPAs than pass plays.  Presumably, this is mostly because run plays are unexpected in come-from-behind situations.  Meanwhile, it is predictable for an offense to pass when its WP is low, making pass plays less effective.

The break-even WP---where pass plays start to have a higher EPA than run plays---was 13% in 2019.  Theoretically, at this WP, pass plays became sufficiently unpredictable such that passing was more effective than running.  Pass play percentage decreases as WP increases.  Teams that are winning run more, and teams that are losing pass more.   At the break-even WP of 13%, pass play percentage was 73%.

Maximizing passing is desirable because passing almost always provides more EPA than running.  Teams, however, would not want to pass so often to make passing too predictable.  Passing is too predictable at WPs less than 13% because running provides a higher EPA at these WPs.  Teams' 2019 passing rates were more than 73% at these WPs.  The optimum pass percentage in 2019, therefore, should have equaled, but not exceeded, 73%, to provide sufficient unpredictability.

In 2015--2018, optimal pass play percentages were 76%--83%.  The actual pass play percentages, however, were 61%–62% in 2015–2019.

## I. Data Set

NFL play-by-play data from `nflscrapR` was used for this research.  Specifically, Ron Yurko provides play-by-play data for all regular seasons since 2009 in CSV files on GitHub.^[Yurko, R. (2020, January 3). *NflscrapR regular season play-by-play data.* GitHub. http://github.com/ryurko/nflscrapR-data/tree/master/play_by_play_data/regular_season.]

```{r include=FALSE}
#Pre-Processing Steps

#Load the necessary packages
library(tidyverse)
library(na.tools)
library(ggplot2)
library(grid)
library(gridExtra)
library(ggimage)
library(rootSolve)

#Read 2019 play-by-play data from NFLScrapR
pbp19all <- read_csv(url("http://github.com/ryurko/nflscrapR-data/raw/master/play_by_play_data/regular_season/reg_pbp_2019.csv"))
```

From this play-by-play data, the following attributes^[Descriptions of all attributes in the nflscrapR play-by-play data set are available at: Horowitz, M. (n.d.). _Scrape JSON play-by-play._ RDocumentation. http://www.rdocumentation.org/packages/nflscrapR/versions/1.8.3/topics/scrape_json_play_by_play.] were selected for inclusion in the data set:

 > `posteam` (Team with possession)  
 > `down`  
 > `ydstogo`   
 > `play_type`  
 > `qb_kneel`  
 > `qb_spike`   
 > `qb_scramble`   
 > `run_location` (left, middle, or right)  
 > `run_gap` (end, guard, or tackle)  
 > `epa` (Expected Points Added for team with possession)  
 > `wp` (Win Probability for team with possession at start of play)  
 > `third_down_converted`  
 > `fourth_down_converted`  
 > `sack`

```{r include=FALSE}
#Select the relevant columns in the play-by-play data
pbp19 <- pbp19all %>% 
  select(posteam, down, ydstogo, play_type, qb_kneel, qb_spike, qb_scramble, run_location, run_gap, epa, wp, third_down_converted, fourth_down_converted, sack)
```

The `play_type` attribute classifies each play as a `pass` (including sacks) or a `run` (including scrambles).  Other `play_type` indicators include:  `punt`, `field_goal`, `kickoff`, `extra_point`, `qb_kneel`, `qb_spike`, and `no_play` (timeouts and penalties).  The `play_type` is blank for rows indicating the end of play.

The data was filtered by `play_type` so that only `pass` plays and `run` plays were included.  Also, 2-point conversion attempts (which have a `down`=NA), and any plays that have NAs for `epa` or `wp` were removed from the data set.

```{r include=FALSE}
#Only include pass & run plays & remove 2-pt conversions (down=NA), & NAs for EPAs & WPs
pbp19_rp <- pbp19 %>% 
  filter(play_type=="pass" | play_type=="run", down<=4, !is_na(epa), !is_na(wp))
```

The `nflscrapR` data provides `run_location` and `run_gap` information that allows for an evaluation of running play success by run direction. Recent research has examined which run play locations have been most successful.  In *The NFL's Run Gap Secret*,^[Seth, Tej. (2020, July 15). *The NFL's run gap secret.* M-Fans. The Michigan Football Analytics Society. http://mfootballanalytics.com/2020/07/15/the-nfls-run-gap-secret.] Tej Seth shows that runs outside the tackles result in higher EPAs than inside runs. Similarly, in *Big, Useful Data Says Outside Rushes are the New Market Inefficiency*,^[Morse, D. (2019, October 22). *Big, useful data says outside rushes are the new market inefficiency.* Sports Illustrated. http://www.si.com/nfl/washingtonfootball/gm-report/epa-week-8-nfl-power-rankings-where-to-run.] Dan Morse shows that rushing outside has been slightly more successful than rushing up the middle, except for short yardage situations (less than 5 yards to go).

To confirm and apply these previous findings, the data was split into three types of plays:  outside runs, middle runs, and pass plays.  "Middle runs" include runs having a `run_location` of `middle` or a `run_gap` of `guard`.  Running plays toward the `run_gap` of `tackle` or `end` were classified as "outside runs."  

Running plays having a `run_location`=NA are not included in the data set, as these plays are generally aborted plays such as fumbles by the quarterback at the snap.  Also, because quarterback scrambles are often intended to be pass plays, scrambles were redefined as "pass plays."

```{r include=FALSE}
#Create new column for specific run direction & redefine QB scrambles as pass plays
pbp19_rp <- pbp19_rp %>%
  mutate(play_dir = case_when(
    qb_scramble == 0 & play_type == "run" & run_location == "middle" ~ "middle run",
    qb_scramble == 0 & play_type == "run" & run_location == "left" & run_gap == "guard" ~ "middle run",
    qb_scramble == 0 & play_type == "run" & run_location == "left" & run_gap == "tackle" ~ "outside run",
    qb_scramble == 0 & play_type == "run" & run_location == "left" & run_gap == "end" ~ "outside run",
    qb_scramble == 0 & play_type == "run" & run_location == "right" & run_gap == "guard" ~ "middle run",
    qb_scramble == 0 & play_type == "run" & run_location == "right" & run_gap == "tackle" ~ "outside run",
    qb_scramble == 0 & play_type == "run" & run_location == "right" & run_gap == "end" ~ "outside run",
    play_type == "pass" ~ "pass play",
    qb_scramble == 1 ~ "pass play"
  ))

#Create new columns based on redefined run & pass plays
pbp19_rp <- pbp19_rp %>%
  mutate(run_pass = ifelse(play_dir=="pass play", "pass", "run")) %>%
  mutate(pass_pct_count = ifelse(play_dir=="pass play", 1, 0))
```

## II. Expected Points Added (Pass Plays vs. Running Plays)

As shown in the following table, on average in 2019, passing plays gained 0.07 EPA/play, while running plays to the outside lost 0.01 EPA/play, and running plays up the middle lost 0.06 EPA/play.

```{r include=FALSE}
#Compare EPAs of pass plays & each run direction
pbp19_rp %>%
  filter(!is_na(run_pass)) %>%
  group_by(play_dir) %>%
  summarize(mean_epa = mean(epa)) %>%
  arrange(desc(mean_epa))
```

*Table 1: EPA/play in 2019.*

|              | EPA/play (2019)  | 
|--------------|------------------|
| Pass Plays   |\ 0.0686          |
| Outside Runs | -0.0122          |
| Middle Runs  | -0.0578          |

Summarizing the data at each down and distance scenario gives further insight into the comparative values of running and passing.  On first and second downs, all plays (whether or not a first down was converted) are relevant.  The following graphs are linear regression models that show how average EPA varied based on yards-to-go on first and second down for running and passing plays in 2019.

*Figure 1: EPA by Yards-to-Go & Play Type on 1st & 2nd Downs (2019).*

```{r echo=FALSE, message=FALSE, fig.width=10, fig.height=3}
#First Down Analysis of EPA by Play Type

#Check how the EPAs of each play type vary based on yards-to-go to first down
ytg_1 <- pbp19_rp %>%
  filter(!is_na(run_pass), down==1) %>%
  group_by(ydstogo, play_dir) %>%
  summarize(mean_epa = mean(epa))

#Plot the EPAs for each play type
ytg_1_plot <- ggplot(ytg_1,aes(x=ydstogo,y=mean_epa,color=play_dir)) + 
  geom_smooth(method="lm", fullrange=TRUE, se=FALSE) +
  scale_x_reverse() + coord_cartesian(xlim=c(20, 0), ylim=c(-0.25,0.25)) +
  ggtitle("First Down") +
  labs(x="Yards to Go", y="Expected Points Added\n (EPA)") +
  geom_label(aes(x=16, y=0.175, label=("Pass\n Plays"), fontface="bold",
                 color="pass play"), size=2.5, show.legend = FALSE) + 
  geom_label(aes(x=16, y=0.025, label=("Outside\n Runs"), fontface="bold",
                 color="outside run"), size=2.5, show.legend = FALSE) +
  geom_label(aes(x=16, y=-0.1, label=("Middle\n Runs"), fontface="bold",
                 color="middle run"), size=2.5, show.legend = FALSE) +
  geom_vline(xintercept=0, color="yellow", size=5) +
  theme(plot.title = element_text(hjust = 0.5), legend.position="none")

#----------------------------------------------------------------------

#Second Down Analysis of EPA by Play Type

#Check how the EPAs of each play type vary based on yards-to-go to first down
ytg_2 <- pbp19_rp %>%
  filter(!is_na(run_pass), down==2) %>%
  group_by(ydstogo, play_dir) %>%
  summarize(mean_epa = mean(epa))

#Plot the EPAs for each play type
ytg_2_plot <- ggplot(ytg_2,aes(x=ydstogo,y=mean_epa,color=play_dir)) + 
  geom_smooth(method="lm", fullrange=TRUE, se=FALSE) +
  scale_x_reverse() + coord_cartesian(xlim=c(20, 0), ylim=c(-0.25,0.25)) +
  ggtitle("Second Down") +
  labs(x="Yards to Go", y="Expected Points Added\n (EPA)") +
  geom_label(aes(x=16, y=-0.075, label=("Pass\n Plays"), fontface="bold",
                 color="pass play"), size=2.5, show.legend = FALSE) + 
  geom_label(aes(x=18, y=-0.2, label=("Outside\n Runs"), fontface="bold",
                 color="outside run"), size=2.5, show.legend = FALSE) +
  geom_label(aes(x=13, y=-0.2, label=("Middle\n Runs"), fontface="bold",
                 color="middle run"), size=2.5, show.legend = FALSE) +
  geom_vline(xintercept=0, color="yellow", size=5) +
  theme(plot.title = element_text(hjust = 0.5), legend.position="none")

#----------------------------------------------------------------------

#Compare down & distance plots for first and second downs
grid.arrange(ytg_1_plot, ytg_2_plot, nrow=1, bottom=textGrob("Data from nflscrapR", gp=gpar(fontsize=9)))
```

In these graphs, the yellow line represents the first down marker.  In 2019, passing plays almost always had higher EPAs than running plays on first and second downs. For the specific data point of first down and 10 yards to go (not shown), on average, passing plays obtained an EPA of 0.109, running outside obtained an EPA of -0.021, and running up the middle obtained an EPA of -0.095.

```{r include=FALSE}
#Determine average EPAs on 1st and 10
ytg_1_10 <- ytg_1 %>%
  filter(ydstogo==10)

ytg_1_10
```

One exception where running plays obtain higher EPAs than passing plays is at first down and less than 6 yards to go (for example, 1st and 5, after a penalty).  At this point, running became more effective than passing on first down.  

Generally, outside runs provided higher EPAs than running up the middle.  Running up the middle, however, becomes as effective as running outside as the offense gets closer to a first down.  On second down, running up the middle and running outside became equally effective at 3 yards to go and less. 

Next, in comparing third and fourth downs, it is best to determine the effectiveness of passing plays and running plays only in cases where a first down conversion was successful.  Again, the following linear regression models show how average EPA varied based on yards-to-go on third and fourth down conversions for running and passing plays in 2019.

*Figure 2: EPA by Yards-to-Go & Play Type for 3rd & 4th Down Conversions (2019).*

```{r echo=FALSE, message=FALSE, fig.width=10, fig.height=3}
#Third Down Analysis of EPA by Play Type

#Check how the EPAs of each play type vary based on yards-to-go to first down
ytg_3 <- pbp19_rp %>%
  filter(!is_na(run_pass), down==3, third_down_converted==1) %>%
  group_by(ydstogo, play_dir) %>%
  summarize(mean_epa = mean(epa))

#Plot the EPAs for each play type
ytg_3_plot <- ggplot(ytg_3,aes(x=ydstogo,y=mean_epa,color=play_dir)) + 
  geom_smooth(method="lm", fullrange=TRUE, se=FALSE) +
  scale_x_reverse() + coord_cartesian(xlim=c(15, 0), ylim=c(0.5,3.5)) +
  ggtitle("Third Down") +
  labs(x="Yards to Go", y="Expected Points Added\n (EPA)") +
  geom_label(aes(x=8, y=2.4, label=("Pass\n Plays"), fontface="bold",
                 color="pass play"), size=2.5, show.legend = FALSE) + 
  geom_label(aes(x=10.75, y=2.25, label=("Outside\n Runs"), fontface="bold", color="outside run"), size=2.5, show.legend = FALSE) +
  geom_label(aes(x=12.5, y=2, label=("Middle\n Runs"), fontface="bold",
                 color="middle run"), size=2.5, show.legend = FALSE) +
  geom_vline(xintercept=0, color="yellow", size=5) +
  theme(plot.title = element_text(hjust = 0.5), legend.position="none")

#----------------------------------------------------------------------

#Fourth Down Analysis of EPA by Play Type

#Check how the EPAs of each play type vary based on yards-to-go to first down
ytg_4 <- pbp19_rp %>%
  filter(!is_na(run_pass), down==4, fourth_down_converted==1) %>%
  group_by(ydstogo, play_dir) %>%
  summarize(mean_epa = mean(epa))

#Plot the EPAs for each play type
ytg_4_plot <- ggplot(ytg_4,aes(x=ydstogo,y=mean_epa,color=play_dir)) + 
  geom_smooth(method="lm", fullrange=TRUE, se=FALSE) +
  scale_x_reverse() + coord_cartesian(xlim=c(10, 0), ylim=c(0,4.5)) +
  ggtitle("Fourth Down") +
  labs(x="Yards to Go", y="Expected Points Added\n (EPA)") +
  geom_label(aes(x=6.25, y=3, label=("Pass\n Plays"), fontface="bold",
                 color="pass play"), size=2.5, show.legend = FALSE) + 
  geom_label(aes(x=7.5, y=4, label=("Outside\n Runs"), fontface="bold",
                 color="outside run"), size=2.5, show.legend = FALSE) +
  geom_label(aes(x=5, y=1.35, label=("Middle\n Runs"), fontface="bold",
                 color="middle run"), size=2.5, show.legend = FALSE) +
  geom_vline(xintercept=0, color="yellow", size=5) +
  theme(plot.title = element_text(hjust = 0.5), legend.position="none")

#----------------------------------------------------------------------

#Compare down & distance plots for third and fourth downs
grid.arrange(ytg_3_plot, ytg_4_plot, nrow=1, bottom=textGrob("Data from nflscrapR", gp=gpar(fontsize=9)))
```

On third down, passing plays continued to get higher EPAs than running plays.  Outside runs were more effective than middle runs until about 2½ yards to go.

On fourth down, it appears at first that outside running was more effective than passing.  These results, however, may driven by a small sample size because there were only 34 outside runs that resulted in fourth down conversions in 2019.  Furthermore, the overall average of pass plays' EPA for fourth down conversions was 3.01, which is higher than the overall average of outside running plays' EPA of 2.95.

```{r include=FALSE}
#Determine the overall EPA averages for fourth down conversions
pbp19_rp %>%
  filter(!is_na(run_pass), down==4, fourth_down_converted==1) %>%
  group_by(play_dir) %>%
  summarize(mean_epa = mean(epa), total=n())
```

The $R^2$ values for each of the linear regression models are as follows:

```{r include=FALSE}
#Determine R squared values of linear regression models

#First Down
lm1_pass <- lm(mean_epa ~ ydstogo, 
               data=ytg_1[ytg_1$play_dir=="pass play",])
summary(lm1_pass) #0.0541

lm1_outside_run <- lm(mean_epa ~ ydstogo, 
                      data=ytg_1[ytg_1$play_dir=="outside run",])
summary(lm1_outside_run) #0.0115

lm1_middle_run <- lm(mean_epa ~ ydstogo, 
                     data=ytg_1[ytg_1$play_dir=="middle run",])
summary(lm1_middle_run) #0.1335

#Second Down
lm2_pass <- lm(mean_epa ~ ydstogo, 
               data=ytg_2[ytg_2$play_dir=="pass play",])
summary(lm2_pass) #0.3326

lm2_outside_run <- lm(mean_epa ~ ydstogo, 
                      data=ytg_2[ytg_2$play_dir=="outside run",])
summary(lm2_outside_run) #0.3303

lm2_middle_run <- lm(mean_epa ~ ydstogo, 
                     data=ytg_2[ytg_2$play_dir=="middle run",])
summary(lm2_middle_run) #0.3617

#Third Down Conversions
lm3_pass <- lm(mean_epa ~ ydstogo, 
               data=ytg_3[ytg_3$play_dir=="pass play",])
summary(lm3_pass) #0.8089

lm3_outside_run <- lm(mean_epa ~ ydstogo, 
                      data=ytg_3[ytg_3$play_dir=="outside run",])
summary(lm3_outside_run) #0.4327

lm3_middle_run <- lm(mean_epa ~ ydstogo, 
                     data=ytg_3[ytg_3$play_dir=="middle run",])
summary(lm3_middle_run) #0.3865

#Fourth Down Conversions
lm4_pass <- lm(mean_epa ~ ydstogo, 
               data=ytg_4[ytg_4$play_dir=="pass play",])
summary(lm4_pass) #0.0254

lm4_outside_run <- lm(mean_epa ~ ydstogo, 
                      data=ytg_4[ytg_4$play_dir=="outside run",])
summary(lm4_outside_run) #0.4161

lm4_middle_run <- lm(mean_epa ~ ydstogo, 
                     data=ytg_4[ytg_4$play_dir=="middle run",])
summary(lm4_middle_run) #1.0
```

\newpage
*Table 2: $R^2$ Values.*  

| Play Type    | 1st Down  | 2nd Down | 3rd Down Conversions | 4th Down Conversions |
|-----------   |-----------|----------|----------------------|---------------------|
| Pass Plays   | 0.0541 | 0.3326 | 0.8089 | 0.0254 |
| Outside Runs | 0.0115 | 0.3303 | 0.4327 | 0.4161 |
| Middle Runs  | 0.1335 | 0.3617 | 0.3865 | 1.0    |

These $R^2$ values suggest that overall, the models best describe second and third down situations.  As discussed above, there are insufficient sample sizes at fourth down in a single season to produce an accurate fit.  For example, the $R^2$ value of 1 for fourth down conversions on runs up the middle is a result of only having two data points for successful fourth down conversions resulting from runs up the middle (one at 4th and 1 and one at 4th and 2).

Similarly, it is uncommon to have first down and something other than 10 yards to go, so the first down model likewise suffers from a lack of sufficient data for situations other than 1st and 10.  

> ***Key Point 1***   
> 
> * *In 2019, passing plays had higher EPAs than running plays in almost every game situation.* 
>   + *The only exception was on first down at less than 6 yards to go, where running plays had higher EPAs than passing plays.*  

> ***Key Point 2***  
>
> * *When running the ball in 2019, running to the outside resulted in higher EPAs than running up the middle, except in short yardage situations on second and third downs.*
>   + *On second down, running up the middle became as or more effective than running outside at 3 yards to go or less.*
>   + *On third down conversions, running up the middle became as or more effective than running outside at 2½ yards to go or less.*

> ***Key Point 3*** 
>
>* *There is insufficient data to fully support the overall models for first and fourth downs. However, the 2019 data does show that:*
>   + *On first down and 10 yards to go, passing plays obtained 0.13 more EPA than running outside, and 0.20 more EPA than running up the middle.*
>   + *On fourth down, pass plays obtained a higher EPA on average than running plays.*

## III. Pass/Run Ratios in 2019

```{r include=FALSE}
#Determine total number of pass and run plays in 2019
pbp19_rp_sum <- pbp19_rp %>%
  filter(!is_na(run_pass)) %>%
  group_by(run_pass) %>%
  summarize(play_count=n(), scrambles=sum(qb_scramble), sacks=sum(sack))

pbp19_rp_sum
```

For the 2019 data set, there were 19,717 passing plays and 12,087 running plays.  This corresponds to a passing play percentage of 62% and a pass/run ratio of 1.63.

```{r include=FALSE}
#Pass Play Percentage
pbp19_rp_sum$play_count/sum(pbp19_rp_sum$play_count)

#Pass/Run Ratio
pbp19_rp_sum$play_count[pbp19_rp_sum$run_pass=="pass"]/pbp19_rp_sum$play_count[pbp19_rp_sum$run_pass=="run"]
```

This is a higher pass/run ratio than reported on *Pro-Football-Reference.com* and *NFL Ops Stats Central*.  *Pro-Football-Reference.com* indicates that there were 17,853 league-wide passing attempts,^[NFL season by season passing (2020). Pro Football Reference. http://www.pro-football-reference.com/years/NFL/passing.htm.] and 13,387 rushing attempts.^[NFL season by season rushing & receiving (2020). Pro Football Reference. http://www.pro-football-reference.com/years/NFL/rushing.htm.]  Likewise, *NFL Ops Stats Central* indicates that there were 54.9% passing plays and 41.2% rushing plays in 2019.^[Chart the data (2020). NFL Football Operations. http://operations.nfl.com/stats-central/chart-the-data. Use the interactive dropdown menus to compare % Rushing Plays to % Passing Plays.]  Each of these statistics provides a pass/run ratio of 1.33 (17,853/13,387 = 1.33 and 54.9/41.2 = 1.33).

The pass/run ratio of 1.63, however, classifies each `qb_scramble` and `sack` as "pass plays."  There were 781 scrambles and 1,268 sacks included in the passing play total.  Also, the data subset excludes each `qb_kneel` and `qb_spike` because `nflscrapR` does not classify them as either a `pass` or a `run`.  There are 399 kneel-downs and 75 spikes excluded from the data.

```{r include=FALSE}
#Total scrambles & sacks
pbp19_rp_sum

#Total QB knees excluded
sum(pbp19$qb_kneel)

#Total QB spikes excluded
sum(pbp19$qb_spike)
```

Making these adjustments would result in a pass/run ratio of 1.3.  Specifically, the number of pass plays would be:
    $$19,717 - 781\ scrambles - 1,268\ sacks + 75\ spikes = 17,743.$$
The number of run plays would be:
    $$12,087 + 781\ scrambles + 399\ knees = 13,267.$$  
Then, the pass/run ratio would be: 
    $$\frac{17,743\ passes}{13,267\ runs} = 1.34.$$
Note that the total numbers of pass plays and run plays do not include penalties or aborted plays, and are less than the totals reported on *Pro-Football-Reference.com*. Nevertheless, the pass/run ratio of 1.3 is equal to that reported in *Pro-Football-Reference.com* and *NFL Ops Stats Central*.

The pass/run ratio of 1.63, however, is a better measure, because it is designed to represent the play call, not the play result.  That is, sacks and quarterback scrambles are intended to be passing plays even if they are not recorded as pass attempts.  Also, penalties are excluded so that the yardage and EPA values on each play are not skewed by penalty yardage.

> ***Key Point 4***   
> 
> * *In 2019, teams called 62% passing plays.* 
>   + *This percentage classifies sacks and scrambles as passing plays, and does not include spikes, kneel-downs, penalties, or aborted plays.*

## IV. Relationship Between WP & EPA

Ben Baldwin recently compared the relationship of EPA/play to WP for passing and running plays.^[Baldwin, B. [@benbbaldwin]. (2019, December 16). _Expected Points Added (EPA) per play vs Win Probability_ [Tweet]. Twitter. http://twitter.com/benbbaldwin/status/1206640759899918336.]

\  
\begin{center}
(Cont'd on Next Page)
\end{center}
\  
\  

```{r echo=FALSE, out.width="450px", out.height="250px", fig.align="center"}

#Load packages to include embedded tweet
library(tweetrmd)
library(webshot2)

#Embed tweet
tweet_screenshot(tweet_url("benbaldwin", "1206640759899918336"))
```

It is also helpful to see the running and passing curves on the same plot as follows.

*Figure 3: WP vs. EPA for Passing & Running Plays (2019).*

```{r echo=FALSE, fig.align="center", fig.height=2.25, fig.width=7, message=FALSE}
#Create new column with rounded WP values to nearest 10
rnd_base <- 10

pbp19_rp <- pbp19_rp %>%
  mutate(wp_round = rnd_base*round((wp*100)/rnd_base))

#Determine EPA at each rounded WP value for pass plays & run plays
epa_wp <- pbp19_rp %>%
  filter(!is_na(run_pass)) %>%
  group_by(wp_round, run_pass) %>%
  summarize(mean_epa = mean(epa), plays=n())

#Determine EPA at each rounded WP value for pass plays
epa_wp_pass <- pbp19_rp %>%
  filter(!is_na(run_pass), run_pass=="pass") %>%
  group_by(wp_round) %>%
  summarize(mean_epa = mean(epa), plays=n())

#Determine EPA at each rounded WP value for run plays
epa_wp_run <- pbp19_rp %>%
  filter(!is_na(run_pass), run_pass=="run") %>%
  group_by(wp_round) %>%
  summarize(mean_epa = mean(epa), plays=n())

#Plot the EPAs at each rounded WP value for pass plays & run plays
plot_epa_wp <- ggplot(epa_wp, aes(x=wp_round, y=mean_epa, color=run_pass)) +
  geom_point() + 
  geom_smooth(method="loess", aes(fill=run_pass)) +
  labs(x="Win Probability (WP)", y="Expected Points Added\n(EPA)", 
       caption = "Data from nflscrapR") +
  scale_color_discrete(labels=c("Pass EPA", "Run EPA")) +
  scale_fill_discrete(labels=c("Pass EPA", "Run EPA")) +
  theme(legend.title=element_blank())

plot_epa_wp
```

In this plot, each WP is rounded to the nearest 10.  This allows for discrete WP data points at which the EPAs are averaged.  Using multiples of 10 also provides larger sample sizes at each WP data point, and reduces the noise of the plot by only including 11 data points.   

The resulting plot shows that at low WPs---when passes are expected---running plays have higher EPAs than passing plays.  The two lines intersect at the "break-even point"---the WP where passing gets higher EPAs than running.

```{r include=FALSE}
#Determine the WP where the lines intersect
f1 <- loess(epa_wp_pass$mean_epa ~ epa_wp_pass$wp_round, data=epa_wp_pass)
f2 <- loess(epa_wp_run$mean_epa ~ epa_wp_run$wp_round, data=epa_wp_run)

intersect <- function(x) {predict(f1, x)-predict(f2,x)}
intersect_val <- uniroot.all(intersect, lower=9, upper=15) 

intersect_val
```

For 2019, the intersection point was at a WP of 13%.  In other words, passes are predictable at a win probability less than 13% and consequently have lower EPAs than run plays.

\newpage
*Figure 4: WP vs. EPA Break-Even Point (2019).*

```{r echo=FALSE, fig.align="center", fig.height=3, fig.width=7, message=FALSE}
#Annotate the plot to illustrate conclusion
plot_epa_wp_ann <- plot_epa_wp + 
  geom_vline(aes(xintercept=intersect_val)) +
  annotate(geom="label", x=12.5, y=0.21, label="WP = 13%", 
           fontface="bold", size=3) +
  geom_segment(aes(x=12.5, y=0.18, xend=-4, yend=0.18, color="run"), 
               arrow = arrow(length = unit(0.5, "cm")),
               size=1.5, show.legend = FALSE) +
  geom_segment(aes(x=13.7, y=0.18, xend=31, yend=0.18, color="pass"), 
               arrow = arrow(length = unit(0.5, "cm")),
               size=1.5, show.legend = FALSE) +
  geom_label(aes(x=5, y=0.12, label=("Run\n Higher\n EPA"), fontface="bold", color="run"), size=3, show.legend = FALSE) + 
  geom_label(aes(x=21.5, y=0.12, label=("Pass\n Higher\n EPA"), fontface="bold", color="pass"), size=3, show.legend = FALSE)

plot_epa_wp_ann
```

> ***Key Point 5***   
> 
> * *In 2019, running plays had higher EPAs than passing plays at win probabilities of 13% or less.* 
>   + *Running plays have higher EPAs than passing plays when passing is predictable.* 

## V. Relationship Between WP & Passing Plays

There is also a relationship between WP and the percentage of passing plays that an offense calls.  That is, when the offense has a low probability of winning, the offense calls more passing plays.  When the offense has a high probability of winning, the offense runs the ball more.  The relationship between the percentage of passing plays that an offense calls to the offense's WP is shown as follows.

*Figure 5: WP vs. Pass Play Percentage (2019).*

```{r echo=FALSE, fig.align="center", fig.height=2.1, fig.width=7, message=FALSE}
#Determine total number of plays at each WP
epa_wp_total <- pbp19_rp %>%
  filter(!is_na(run_pass)) %>%
  group_by(wp_round) %>%
  summarize(total_plays=n())

#Add the total number of plays at each WP as a separate column
epa_wp_pct <- merge(epa_wp, epa_wp_total, by="wp_round")

#Add a new column for percentage of each play type at each WP
epa_wp_pct <- epa_wp_pct %>%
  mutate(pct_plays = (epa_wp_pct$plays/epa_wp_pct$total_plays)*100)

#Filter out the pass plays
epa_wp_pct_pass <- epa_wp_pct %>%
  filter(run_pass=="pass")

#Plot the percentage of pass plays vs. WP
plot_pass_pct_wp <- ggplot(epa_wp_pct_pass, aes(x=wp_round, y=pct_plays, lty = "Pass %")) +
  geom_point(color="blue") +
  labs(x="Win Probability (WP)",y="\nPass Play Percentage\n ", 
       caption = "Data from nflscrapR") +
  geom_smooth(method="loess", color="blue") + 
  theme(legend.title=element_blank())

plot_pass_pct_wp
```

This plot shows that pass play percentage steadily decreases as winning percentage increases.  There is a steep decrease in the pass play percentage after the win probability reaches 80%.

Meanwhile, the optimal pass play percentage will be the pass play percentage at a win probability of 13%.  At this point, the number of running plays are large enough such that passing is unpredictable, and the passing plays' EPAs are not lower than running plays' EPAs. The typical passing play percentage at a 13% WP is 73%.

```{r include=FALSE}
#Model pass percentage as function of WP
f3 <- loess(epa_wp_pct_pass$pct_plays ~ epa_wp_pct_pass$wp_round, 
            data=epa_wp_pct_pass)

opt_pr <- predict(f3, intersect_val)

opt_pr
```

```{r include=FALSE}
#Annotate the plot to illustrate conclusion
plot_pass_pct_wp_ann <- plot_pass_pct_wp + 
  geom_segment(x=intersect_val, y=0, xend=intersect_val, yend=opt_pr) +
  geom_segment(x=intersect_val, y=opt_pr, xend=-5, yend=opt_pr) + 
  geom_segment(x=20, y=85, xend=-5, yend=opt_pr, 
             arrow = arrow(length = unit(0.5, "cm")), size=0.75, 
             show.legend = FALSE) +
  geom_label(x=12.5, y=35, label="WP = 13%", fontface="bold",
               size=3, show.legend = FALSE) +
  geom_label(x=22, y=85, label="Optimum Pass%\n= 73%", fontface="bold",
                size=3, show.legend = FALSE)
  
plot_pass_pct_wp_ann
```

Accordingly, because it is best to maximize passing in almost all game situations, the optimal pass percentage in 2019 was 73%.  This was 11% higher than teams' actual pass play percentage of 62% in 2019.

The following plot illustrates that 13% was the break-even WP at which passing becomes more effective than running, and that the average passing percentage at the break-even win probability is 73%.

*Figure 6: Optimal Passing Percentage (2019).*

```{r echo=FALSE, fig.align="center", fig.height=5.25, fig.width=7, message=FALSE}
#Compare (1) pass plays % vs. WP to (2) EPAs of run & pass plays vs. EPA
grid.arrange(plot_pass_pct_wp_ann + 
               labs(caption="") + 
               theme(legend.position=c(.95,.6), legend.justification='right'), 
             plot_epa_wp_ann + 
               labs(caption="") + 
               theme(legend.position=c(.95, .475),
                     legend.justification='right'),
             nrow=2, 
             bottom=textGrob("Data from nflscrapR", gp=gpar(fontsize=9)))
```

> ***Key Point 6***
>
> * *The percentage of passing plays decreases as WP increases.*
>   + *Pass play percentage decreases fastest at about an 80% WP and above.*

> ***Key Point 7***   
> 
> * *The passing play percentage corresponding to a 13% WP is 73%.*
> * *Accordingly, the optimum pass play percentage in 2019 was 73%*
>   + *The optimal pass play percentage balances maximizing pass plays while keeping pass plays sufficiently unpredictable such that passing plays would not have lower EPAs than running plays.* 

## VI. Years 2015--2018

Play-by-play data from `nflscrapR` for each of the 2015--2018 seasons provide similar results to the 2019 season.

```{r include=FALSE}
#Download the data for the past 5 seasons into a data frame

first <- 2015 #first season to grab
last <- 2019 #last season to grab

pbpold_list = list()
for (yr in first:last) {
  pbp <- read_csv(url(paste0("http://github.com/ryurko/nflscrapR-data/raw/master/play_by_play_data/regular_season/reg_pbp_", yr, ".csv")))
  pbp <- pbp %>% select(posteam, down, play_type, qb_scramble, run_location, epa, wp) %>% mutate(season_yr=yr)
  pbpold_list[[yr]] <- pbp #add it to the list
}

pbpold <- dplyr::bind_rows(pbpold_list)

#Create new column with rounded WPs to nearest 10
rnd_base <- 10

pbpold <- pbpold %>%
  mutate(wp_round = rnd_base*round((wp*100)/rnd_base))

#Redefine QB scrambles to be pass plays & filter out 2-pt conversions (down=NA), & NAs for EPAs & WPs
pbpold <- pbpold %>%
  filter(play_type=="pass" | play_type=="run", down<=4, 
         !is_na(epa), !is_na(wp)) %>%
  mutate(run_pass = ifelse(play_type=="pass" | qb_scramble==1, "pass", "run"))

#Filter out run location NAs on running play types (ex., fumbled snaps)
pbpold <- pbpold %>%
  filter(run_pass=="pass" | play_type=="run" & !is_na(run_location))
```

First, the percentage of pass plays called in 2015--2018 were nearly identical to 2019.  Specifically, the pass play percentages were 62% in each of 2015, 2016, 2018, and 2019.  The pass play percentage was 60% in 2017.

```{r include=FALSE}
#Determine actual pass play percentages for leagues from 2015-2018
pbp_rp_list = list()
for (yr in first:last) {
  
  pbp19_rp_sum_old <- pbpold %>%
    filter(season_yr==yr) %>%
    group_by(run_pass) %>%
    summarize(play_count=n())
  
  pbp_rp_list[[yr]] <- pbp19_rp_sum_old$play_count/sum(pbp19_rp_sum_old$play_count)
}

pbp_rp_list[[2015]] 
pbp_rp_list[[2016]]
pbp_rp_list[[2017]]
pbp_rp_list[[2018]]
pbp_rp_list[[2019]]
```

The relationship between pass play percentage and WP has also remained steady over the last five years as shown below:

*Figure 7: WP vs. Pass Play Percentage in 2015--2019.*

```{r echo=FALSE, fig.align="center", fig.height=2, fig.width=7, message=FALSE}
#Plots of WP vs. Pass Play Percentage
epa_wp_list = list()
epa_wp_pct_pass_list = list()

for (yr in first:last) {
  
  #Determine EPA at each rounded WP values for all plays for the last 4 seasons
  epa_wp_old <- pbpold %>%
    filter(season_yr==yr) %>%
    group_by(wp_round, run_pass) %>%
    summarize(mean_epa = mean(epa), plays=n())
  epa_wp_list[[yr]] <- epa_wp_old
  
  #Determine total number of plays at each WP
  epa_wp_total_old <- pbpold %>%
    filter(!is_na(epa), season_yr==yr) %>%
    group_by(wp_round) %>%
    summarize(total_plays=n())
  
  #Add the total number of plays at each WP as a separate column
  epa_wp_pct_old <- merge(epa_wp_list[[yr]], epa_wp_total_old, by="wp_round")
  
  #Add a new column for percentage of each play type at each WP
  epa_wp_pct_old <- epa_wp_pct_old %>%
    mutate(pct_plays = (epa_wp_pct_old$plays/epa_wp_pct_old$total_plays)*100)
  
  #Filter out the pass plays
  epa_wp_pct_pass_old <- epa_wp_pct_old %>%
    filter(run_pass=="pass")
  
  #Add pass play % vs. WP to list
  epa_wp_pct_pass_list[[yr]] <- epa_wp_pct_pass_old
}

#Plot each of the 5 seasons on the same graph
epa_wp_pct_pass_compare <- epa_wp_pct_pass_list[[2015]] %>% 
  mutate(Season="2015") %>%
  bind_rows(epa_wp_pct_pass_list[[2016]] %>% mutate(Season="2016")) %>%
  bind_rows(epa_wp_pct_pass_list[[2017]] %>% mutate(Season="2017")) %>%
  bind_rows(epa_wp_pct_pass_list[[2018]] %>% mutate(Season="2018")) %>%
  bind_rows(epa_wp_pct_pass_list[[2019]] %>% mutate(Season="2019"))

ggplot(epa_wp_pct_pass_compare, aes(y=pct_plays, x=wp_round, color=Season)) +
  geom_smooth(method="loess", se=FALSE) + 
  labs(x="Win Probability (WP)",y="Pass Play\nPercentage", 
       caption="Data from nflscrapR")
```

These plots of pass play percentage at each WP are very similar from year to year. The percentage of pass plays called at each WP changed little over the past 5 years.

Next, comparisons of EPAs at the different WPs for running and passing plays in 2015--2018 show the following:

*Figure 8: WP vs. EPA for Running & Passing Plays in 2015--2018.*

```{r echo=FALSE, fig.align="center", fig.height=3.5, fig.width=7, message=FALSE}
#Plot the EPAs at each rounded WP value for pass plays & run plays
plot_epa_wp_list = list()
for (yr in first:last) {
  plot_epa_wp <- ggplot(epa_wp_list[[yr]], aes(x=wp_round, y=mean_epa, color=run_pass)) +
    geom_point() + 
    geom_smooth(method="loess", aes(fill=run_pass)) +
    labs(x="Win Probability (WP)", y="Expected Points Added\n(EPA)", 
         title = paste0(yr," Season")) +
    scale_color_discrete(labels=c("Pass EPA", "Run EPA")) +
    scale_fill_discrete(labels=c("Pass EPA", "Run EPA")) +
    theme(legend.title=element_blank())
  plot_epa_wp_list[[yr]] <- plot_epa_wp 
}

#Compare the 4 seasons
grid.arrange(plot_epa_wp_list[[2015]], plot_epa_wp_list[[2016]],
             plot_epa_wp_list[[2017]], plot_epa_wp_list[[2018]],
             nrow=2, bottom=textGrob("Data from nflscrapR", 
                                     gp=gpar(fontsize=9)))
```

There is variability among the WP vs. EPA curves for running and passing plays from year to year. That is, the break-even intersection points change each year. Because the percentages of pass plays have not changed much at each WP, there is presumably more than unpredictable play calling alone that causes the success of run plays at low WPs.

The break-even WPs, and corresponding optimum pass play percentages, in each of the past five years have been:

```{r include=FALSE}
#Determine WP intersect points
intersect_val_list = list()
for (yr in first:last) {
  epa_wp_pass_old <- pbpold %>%
    filter(season_yr==yr, run_pass=="pass") %>%
    group_by(wp_round) %>%
    summarize(mean_epa = mean(epa))
  
  epa_wp_run_old <- pbpold %>%
    filter(!is_na(epa), season_yr==yr, run_pass=="run") %>%
    group_by(wp_round) %>%
    summarize(mean_epa = mean(epa))
  
  f1_old <- loess(epa_wp_pass_old$mean_epa ~ epa_wp_pass_old$wp_round, data=epa_wp_pass_old)
  f2_old <- loess(epa_wp_run_old$mean_epa ~ epa_wp_run_old$wp_round, data=epa_wp_run_old)
  
  intersect_old <- function(x) {predict(f1_old, x)-predict(f2_old,x)}
  intersect_val_old <- uniroot.all(intersect_old, lower=0, upper=15)
  
  intersect_val_list[[yr]] <- intersect_val_old 
}

intersect_val_list[[2015]]
intersect_val_list[[2016]]
intersect_val_list[[2017]]
intersect_val_list[[2018]]
intersect_val_list[[2019]]
```

```{r include=FALSE}
#Model pass percentage as function of WP & determine optimum pass pct
opt_pr_list = list()
for (yr in first:last) {
f3 <- loess(epa_wp_pct_pass_list[[yr]]$pct_plays ~ epa_wp_pct_pass_list[[yr]]$wp_round, 
            data=epa_wp_pct_pass_list[[yr]])

opt_pr <- predict(f3, intersect_val_list[[yr]])

opt_pr_list[[yr]] <- opt_pr
}

opt_pr_list[[2015]]
opt_pr_list[[2016]]
opt_pr_list[[2017]]
opt_pr_list[[2018]]
opt_pr_list[[2019]]
```

*Table 3: Break-Even WPs & Optimum Pass Play Percentages in 2015--2019.*

| Year | Break-Even WP | Optimum Pass Play % |
|------|---------------|---------------------|
| 2015 | 1.43%         | 83.0%               |
| 2016 | 4.93%         | 80.4%               |
| 2017 | 10.6%         | 75.7%               |
| 2018 | 1.79%         | 81.0%               |
| 2019 | 13.1%         | 73.3%               |

Over the past five years, the optimal pass play percentages have ranged from 73%--83%. In every year, the optimum pass play percentage has been higher than the actual pass play percentage of 61%--62%.

> ***Key Point 8***
>
> * *The percentage of passing plays has not changed over the past 5 years.*
>   + *The percentage of passing plays called at each win probability has also stayed about the same over the past 5 years.*  
>
> ***Key Point 9***
>
> * *The EPAs of run and plass plays at each win probability does change from year to year.*  
>   + *As a result, the optimal pass percentage changes from year to year.*  
> 
> ***Key Point 10***  
>
> * *The optimal pass play percentage has ranged from 73%--83% over the past 5 years.*    
>   + *The actual pass play percentage of 61%--62% has always been lower than the optimal pass play percentage for each of the past 5 years.* 

## Conclusion & Limitations

In conclusion, while it is known that passing provides higher EPAs than running, and it is generally assumed that teams should pass the ball more, this research quantifies how much more teams should pass to achieve optimal play calling for maximizing EPA.  Specifically, actual pass play percentages have been 61%--62% over the past five years, but optimal pass play percentages would have been 73%--83%.  

This research identifies the optimum pass play percentage on a league-wide basis, and should vary from year to year as defenses adjust their expectations based on the number of passing plays being called.  Furthermore, the league-wide optimum pass play percentage would correspond to a team having an average passing offense and average passing defense.  Each individual team will have a different optimum pass play percentage based on the relative strengths and weaknesses of their passing and running games.